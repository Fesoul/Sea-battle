<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
    </style>

<body>
  <main>
      <h1 id="header">[[renderHeader]]</h1>
      <section>
          <ul>
              <li class="list"><span>Выстрелов:</span><span id="shot">[[renderShot]]</span></li>
              <li class="list"><span>Попаданий:</span><span id="hit">[[renderHit]]</span></li>
              <li class="list"><span>Потоплено:</span><span id="dead">[[renderDead]]</span></li>
          </ul>
      </section>
      <div class="board">
          <table id="enemy">
              <tr>
                  <td id="00"></td>
                  <td id="01"></td>
                  <td id="02"></td>
                  <td id="03"></td>
                  <td id="04"></td>
                  <td id="05"></td>
                  <td id="06"></td>
                  <td id="07"></td>
                  <td id="08"></td>
                  <td id="09"></td>
              </tr>
              <tr>
                  <td id="10"></td>
                  <td id="11"></td>
                  <td id="12"></td>
                  <td id="13"></td>
                  <td id="14"></td>
                  <td id="15"></td>
                  <td id="16"></td>
                  <td id="17"></td>
                  <td id="18"></td>
                  <td id="19"></td>
              </tr>
              <tr>
                  <td id="20"></td>
                  <td id="21"></td>
                  <td id="22"></td>
                  <td id="23"></td>
                  <td id="24"></td>
                  <td id="25"></td>
                  <td id="26"></td>
                  <td id="27"></td>
                  <td id="28"></td>
                  <td id="29"></td>
              </tr>
              <tr>
                  <td id="30"></td>
                  <td id="31"></td>
                  <td id="32"></td>
                  <td id="33"></td>
                  <td id="34"></td>
                  <td id="35"></td>
                  <td id="36"></td>
                  <td id="37"></td>
                  <td id="38"></td>
                  <td id="39"></td>
              </tr>
              <tr>
                  <td id="40"></td>
                  <td id="41"></td>
                  <td id="42"></td>
                  <td id="43"></td>
                  <td id="44"></td>
                  <td id="45"></td>
                  <td id="46"></td>
                  <td id="47"></td>
                  <td id="48"></td>
                  <td id="49"></td>
              </tr>
              <tr>
                  <td id="50"></td>
                  <td id="51"></td>
                  <td id="52"></td>
                  <td id="53"></td>
                  <td id="54"></td>
                  <td id="55"></td>
                  <td id="56"></td>
                  <td id="57"></td>
                  <td id="58"></td>
                  <td id="59"></td>
              </tr>
              <tr>
                  <td id="60"></td>
                  <td id="61"></td>
                  <td id="62"></td>
                  <td id="63"></td>
                  <td id="64"></td>
                  <td id="65"></td>
                  <td id="66"></td>
                  <td id="67"></td>
                  <td id="68"></td>
                  <td id="69"></td>
              </tr>
              <tr>
                  <td id="70"></td>
                  <td id="71"></td>
                  <td id="72"></td>
                  <td id="73"></td>
                  <td id="74"></td>
                  <td id="75"></td>
                  <td id="76"></td>
                  <td id="77"></td>
                  <td id="78"></td>
                  <td id="79"></td>
              </tr>
              <tr>
                  <td id="80"></td>
                  <td id="81"></td>
                  <td id="82"></td>
                  <td id="83"></td>
                  <td id="84"></td>
                  <td id="85"></td>
                  <td id="86"></td>
                  <td id="87"></td>
                  <td id="88"></td>
                  <td id="89"></td>
              </tr>
              <tr>
                  <td id="90"></td>
                  <td id="91"></td>
                  <td id="92"></td>
                  <td id="93"></td>
                  <td id="94"></td>
                  <td id="95"></td>
                  <td id="96"></td>
                  <td id="97"></td>
                  <td id="98"></td>
                  <td id="99"></td>
              </tr>

          </table>
      </div>
      <a href="#" id="again">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          Начать заново
      </a>
  </main>
</body>
  </template>

  <script>
    class MyView1 extends Polymer.Element {
      static get is() { return 'my-view1'; }  

      static get properties () {
        return {
          renderHeader: {
            type: String,
            value: "МОРСКОЙ БОЙ"
          },
          renderShot: {
            type: Number,
            value: 0
          },
          renderHit: {
            type: Number,
            value: 0
          },
          renderDead: {
            type: Number,
            value: 0
          },
        }
      }

      static get observers() {
        return [ 
          '_initChanged()', 
        ];
      }
      _initChanged(){
        console.log('hit:', this.$.hit);
        const _enemy = this.$.enemy;
        const _shot = this.$.shot;
        const _again = this.$.again;
        this.game.generateShip();
        _enemy.addEventListener('click', this._fireClick);
        _again.addEventListener('click', () => {
          location.reload();
        });
        console.log(this.game.ships);
      }
        game = {
            ships: [],
            shipCount: 0,
            optionShip: {
                count: [1, 2, 3, 4],
                size: [4, 3, 2, 1]
            },
            conflicts: [],
            generateShip() {
                for (let i = 0; i < this.optionShip.count.length; i++) {
                    for (let j = 0; j < this.optionShip.count[i]; j++) {
                      const size = this.optionShip.size[i];
                      const aShip = this.generateOptionsShip(size);
                      this.ships.push(aShip);
                      this.shipCount++;
                    }
                }
            },
            generateOptionsShip(shipSize) {
              const aShip = {
                  hit: [],
                  location: [],
              };

              const direction = Math.random() < 0.5;
              let x, y;

              if(direction) {
                 //ship horizontal generation;
                 x = Math.floor(Math.random() * 10);
                 console.log('x: ', x);
                 y = Math.floor(Math.random() * (10 - shipSize));
                 console.log('y: ', y); 
              } else {
                //ship vertical generation;
                 x = Math.floor(Math.random() * (10 - shipSize));
                 console.log('x: ', x);
                 y = Math.floor(Math.random() * 10); 
                 console.log('y: ', y);
              }

              for(let i = 0; i < shipSize; i++) {
                 if (direction) {
                     aShip.location.push(x + '' + (y + i))
                     console.log('horizontal ship:', aShip.location)
                 } else {
                     aShip.location.push((x + i) + '' + y)
                     console.log('vertical ship:', aShip.location)
                 }
                  aShip.hit.push('');
              }

              if (this.chekConflictZone(aShip.location)) {
                  return this.generateOptionsShip(shipSize);
              }

              this.addConflictZone(aShip.location);

              return aShip;
            },
            chekConflictZone(location) {
                for (const coord of location) {
                    if (this.conflicts.includes(coord)) {
                      return true;
                    }
                }
            },
            addConflictZone(location) {
                for (let i = 0; i < location.length; i++) {
                    const startCoordX = location[i][0] - 1;

                    for (let j = startCoordX; j < startCoordX + 3; j++) {
                        const startCoordY = location[i][1] - 1;

                        for (let z = startCoordY; z < startCoordY + 3; z++) {
                          
                          if (j >= 0 && j < 10 && z >= 0 && z < 10) {
                            const coord = j + '' + z;
                            if (!this.conflicts.includes(coord)) {
                                 this.conflicts.push(coord);
                            }
                          }
                        }
                    }
                }
            }
        };
        
        show = {
        hit(elem) {
          this.changeClass(elem, 'hit');
        },
        miss(elem) {
          this.changeClass(elem, 'miss');
        },
        dead(elem) {
          this.changeClass(elem, 'dead')
        },
        changeClass(elem, value){
              elem.className = value;
        }
      };

      _fireClick = (event) => {
        const target = event.target
        if(target.classList.length !== 0 || 
           target.tagName !== 'TD' || 
           !this.game.shipCount) return;
        this.show.miss(target);
        this.renderShot += 1;

        for(let i = 0; i < this.game.ships.length; i++){
          const ship = this.game.ships[i];
          const index = ship.location.indexOf(target.id);
          if (index >= 0) {
              this.show.hit(target);
              this.renderHit += 1;
              ship.hit[index] = 'x';
              const life = ship.hit.indexOf('');
              if (life < 0) {
                  this.renderDead += 1;
                  for (const id of ship.location){
                    this.show.dead(this.shadowRoot.getElementById(id));
              }

              this.game.shipCount -= 1;

              if(!this.game.shipCount) {
                this.renderHeader = 'ИГРА ОКОНЧЕНА!';
                this.$.header.style.color = 'red';
              }
            }
          }
        }
      };

    }
    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
